@startuml enhanced-live-logging-architecture

!include _standard-style.puml
skinparam linetype ortho
skinparam direction top to bottom layout

title Enhanced Live Session Logging Architecture\n<size:14>Real-Time Intelligent Conversation Capture System</size>

' Top layer - Real-time capture
rectangle "Real-Time Capture Layer" as CaptureLayer #F0F8FF {
    component [StatusLine\nHooks] as StatusHooks <<core>>
    component [Tool\nInteractions] as ToolInt <<api>>
    component [Constraint\nMonitor] as ConstraintMon <<external>>
    
    ToolInt SYNC_LINE StatusHooks : captures
    ConstraintMon CONTROL_LINE StatusHooks : integrates
}

' Processing layer - middle
rectangle "Processing & Intelligence Layer" as ProcessLayer #F0FFF0 {
    component [LiveLogging\nCoordinator] as Coordinator <<agent>>
    component [SemanticTool\nInterpreter] as Interpreter <<core>>
    component [Exchange\nClassifier] as Classifier <<agent>>
    component [HybridSession\nLogger] as Logger <<core>>
    
    Coordinator DATA_LINE Interpreter : processes
    Coordinator SYNC_LINE Classifier : analyzes  
    Coordinator CONTROL_LINE Logger : routes
}

' Intelligence sub-layer
rectangle "Intelligence Components" as IntelLayer #FFFACD {
    component [Tool\nSummarization] as ToolSum <<util>>
    component [Content\nClassification] as ContentClass <<util>>
    component [Context\nAnalysis] as ContextAnal <<util>>
    component [Confidence\nScoring] as ConfScore <<util>>
    
    Interpreter DATA_LINE ToolSum : generates
    Classifier SYNC_LINE ContentClass : performs
    Classifier ASYNC_LINE ContextAnal : considers
    Classifier DATA_LINE ConfScore : calculates
}

' Storage layer - bottom
rectangle "Storage & Persistence Layer" as StorageLayer #FFF9E6 {
    database "Coding\nLogs" as CodingDB <<storage>>
    database "Project\nLogs" as ProjectDB <<storage>>
    database "Session\nMetadata" as SessionMeta <<storage>>
    component [Buffer\nFiles] as BufferFiles <<storage>>
    
    Logger SYNC_LINE CodingDB : writes coding exchanges
    Logger SYNC_LINE ProjectDB : writes project exchanges
    Logger DATA_LINE SessionMeta : maintains
    Coordinator ASYNC_LINE BufferFiles : manages
}

' Integration layer - side
rectangle "Integration Layer" as IntegrationLayer #FFE8F4 {
    cloud [MCP\nMemory] as MCPMem <<external>>
    cloud [Semantic\nAnalysis] as SemAnal <<external>>
    component [PostSession\nBackup] as PostSession <<cli>>
    component [Enhanced\nLogger] as EnhancedLogger <<cli>>
    
    Classifier OPTIONAL_LINE MCPMem : queries
    Classifier OPTIONAL_LINE SemAnal : leverages
    Logger ASYNC_LINE PostSession : supplements
    PostSession SYNC_LINE EnhancedLogger : uses
}

' Main data flow - vertical
CaptureLayer SYNC_LINE ProcessLayer
ProcessLayer SYNC_LINE IntelLayer  
ProcessLayer SYNC_LINE StorageLayer

' Side integration
ProcessLayer OPTIONAL_LINE IntegrationLayer

' Key information flow annotations
note right of Coordinator
**Real-time Processing:**
â€¢ Captures tool interactions as they occur
â€¢ Buffers for batch processing every 5 seconds
â€¢ Maintains session state and metadata
â€¢ Coordinates all processing components
end note

note bottom of Classifier
**Intelligence Classification:**
â€¢ Tools: MCP, knowledge mgmt (30%)
â€¢ Files: coding patterns (25%)
â€¢ Commands: system operations (20%)
â€¢ Concepts: knowledge terms (15%)
â€¢ Context: working directory (10%)

**Routing Logic:**
â€¢ >70% â†’ coding/.specstory/
â€¢ 40-70% â†’ BOTH locations (hybrid)
â€¢ <40% â†’ .specstory/ (project)
end note

note left of Logger
**Meaningful Summaries:**
[Tool: Glob] â†’
"ðŸ” Found 15 files matching *.js"

[Tool: Edit] â†’
"âœï¸ Modified UserProfile.js"

[Tool: mcp__memory] â†’
"ðŸ§  Knowledge Graph: searched"
end note

' Performance annotations
note top of StatusHooks
**Performance Targets:**
â€¢ Tool capture: Real-time (0ms)
â€¢ Interpretation: <50ms
â€¢ Classification: <100ms  
â€¢ Logging: <200ms (async)
â€¢ **Total: <350ms per interaction**
end note

@enduml