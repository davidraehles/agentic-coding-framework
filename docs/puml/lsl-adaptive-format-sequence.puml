@startuml LSL Adaptive Format Detection Sequence
!include _standard-style.puml

title Adaptive Transcript Format Detection - Sequence Flow

actor "Transcript Monitor" as Monitor
participant "StreamingReader" as Reader
participant "AdaptiveExtractor" as Extractor
participant "FormatDetector" as Detector
database "transcript-formats.json" as Config
participant "ExtractionStrategy" as Strategy

== Batch Processing ==
Monitor -> Reader: processFile(transcript.jsonl)
Reader -> Reader: streamLines()
Reader -> Extractor: extractExchangesFromBatch(messages)

== Format Detection Phase ==
Extractor -> Extractor: getOrDetectFormat(messages)

alt Format Cache Hit
  Extractor -> Extractor: formatCache.get(cacheKey)
  note right: Cache TTL: 5 minutes\nAvoids redundant detection
else Format Cache Miss
  Extractor -> Detector: detectFormat(messages)
  
  Detector -> Detector: analyzeMessageBatch(messages)
  note right: Pattern recognition:\n- Message types\n- Structure analysis\n- Exchange boundaries
  
  Detector -> Config: loadKnownFormats()
  Config --> Detector: known formats
  
  alt Known Format Match
    Detector -> Detector: calculateFormatMatch(analysis, format)
    note right: Confidence scoring:\n> 0.8 = match found
  else New Format Detected
    Detector -> Detector: createNewFormat(analysis)
    Detector -> Config: saveFormatsConfig(newFormat)
    note right: Auto-learning:\nPersist new schema
  end
  
  Detector --> Extractor: formatResult
  Extractor -> Extractor: formatCache.set(cacheKey, result)
end

== Extraction Strategy Application ==
Extractor -> Detector: getExtractionStrategy(formatResult)
Detector --> Extractor: strategy configuration

Extractor -> Strategy: extractWithStrategy(messages, strategy)

loop For Each Message
  Strategy -> Strategy: checkUserTurnIndicators()
  alt User Turn Start
    Strategy -> Strategy: startNewExchange()
  else User Turn End  
    Strategy -> Strategy: addUserContent()
  else Assistant Turn
    Strategy -> Strategy: addAssistantContent()
  else Tool Use/Result
    Strategy -> Strategy: addToolInfo()
  end
end

Strategy --> Extractor: extracted exchanges

== Fallback Handling ==
alt Format Detection Failed
  Extractor -> Extractor: extractWithFallback(messages)
  note right: Robust fallback:\nHandles both formats\nZero data loss
end

Extractor --> Reader: exchanges[]
Reader --> Monitor: processed batch

== Statistics & Monitoring ==
Extractor -> Extractor: updateStats()
note right: Track performance:\n- Cache hits/misses\n- Formats detected\n- Processing time

@enduml