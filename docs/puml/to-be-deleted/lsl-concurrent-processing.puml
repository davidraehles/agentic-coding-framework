@startuml LSL Concurrent Processing Data Flow
!include _standard-style.puml

title LSL System - Concurrent Processing & Prompt Sets

package "Real-time Processing" {
  [Enhanced Transcript Monitor] <<core>>
  [Live Classification Engine] <<core>>
  [Prompt Set Generator] <<core>>
}

package "Adaptive Pipeline" {
  [StreamingTranscriptReader] <<core>>
  [AdaptiveExchangeExtractor] <<core>>
  [BatchProcessor] <<util>>
}

package "Classification Layers" {
  [PathAnalyzer] <<util>>
  [KeywordMatcher] <<util>>
  [SemanticAnalyzer] <<util>>
}

package "Concurrent Workers" {
  [Worker 1] <<util>>
  [Worker 2] <<util>>
  [Worker 3] <<util>>
  [Worker 4] <<util>>
  [Worker 5] <<util>>
}

package "Prompt Set Processing" {
  [Prompt Boundary Detection] <<core>>
  [Exchange Grouping] <<core>>
  [Session Time Windows] <<core>>
}

package "Output Management" {
  [Session File Writer] <<core>>
  [LSLFileManager] <<core>>
}

database "Claude Transcripts" <<external>>
database "Session Files (.md)" <<storage>>
database "Foreign Files (_from-X.md)" <<storage>>

' Real-time flow
"Claude Transcripts" ASYNC_LINE [Enhanced Transcript Monitor] : "live stream"
[Enhanced Transcript Monitor] SYNC_LINE [StreamingTranscriptReader]
[StreamingTranscriptReader] SYNC_LINE [AdaptiveExchangeExtractor]

' Concurrent processing
[AdaptiveExchangeExtractor] SYNC_LINE [BatchProcessor]
[BatchProcessor] SYNC_LINE [Worker 1]
[BatchProcessor] SYNC_LINE [Worker 2]
[BatchProcessor] SYNC_LINE [Worker 3]
[BatchProcessor] SYNC_LINE [Worker 4]
[BatchProcessor] SYNC_LINE [Worker 5]

' Classification flow
[Enhanced Transcript Monitor] SYNC_LINE [Live Classification Engine]
[Live Classification Engine] SYNC_LINE [PathAnalyzer]
[Live Classification Engine] SYNC_LINE [KeywordMatcher]
[Live Classification Engine] OPTIONAL_LINE [SemanticAnalyzer]

' Prompt set processing
[Enhanced Transcript Monitor] SYNC_LINE [Prompt Set Generator]
[Prompt Set Generator] SYNC_LINE [Prompt Boundary Detection]
[Prompt Set Generator] SYNC_LINE [Exchange Grouping]
[Prompt Set Generator] SYNC_LINE [Session Time Windows]

' Output routing
[Prompt Set Generator] SYNC_LINE [Session File Writer]
[Session File Writer] SYNC_LINE [LSLFileManager]
[LSLFileManager] DATA_LINE "Session Files (.md)"
[LSLFileManager] DATA_LINE "Foreign Files (_from-X.md)"

note right of [BatchProcessor]
  Parallel Processing:
  - 5 concurrent workers
  - Memory-efficient streaming
  - Automatic load balancing
  - Error recovery per worker
end note

note bottom of [Prompt Set Generator]
  Smart Grouping:
  - User prompt boundaries
  - Session time windows (60min)
  - Tool call sequences
  - Conversation continuity
end note

note right of [Session File Writer]
  Intelligent Routing:
  - Coding → _from-X.md files
  - Project work → regular .md
  - Automatic foreign detection
  - Prevents data loss
end note

@enduml