@startuml
!include _standard-style.puml

title Process Monitoring Architecture

package "Process State Manager (PSM)" <<Database>> {
  component [Process Registry\n.live-process-registry.json] as PSM_Registry <<storage>>
  component [Lock Manager\n(proper-lockfile)] as Lock <<util>>

  PSM_Registry -down-> Lock : atomic operations
}

package "Service Management Layer" {
  component [Global Service\nCoordinator] as Coordinator <<core>>
  component [start-services.sh] as StartScript <<cli>>

  Coordinator -> PSM_Registry : register/query/unregister
  StartScript -> PSM_Registry : register services
}

package "Monitoring Layer" {
  component [System Monitor\nWatchdog] as Watchdog <<infra>>
  component [Monitoring\nVerifier] as Verifier <<infra>>

  Watchdog -> PSM_Registry : check coordinator health
  Verifier -> PSM_Registry : verify system health
}

package "Session Management" {
  component [launch-claude.sh] as LaunchClaude <<cli>>
  component [Session Cleanup] as Cleanup <<util>>

  LaunchClaude -> PSM_Registry : register session
  Cleanup -> PSM_Registry : cleanup session services
}

package "Running Services" {
  component [Constraint\nDashboard] as Dashboard <<api>>
  component [Enhanced\nTranscript Monitor] as TranscriptMon <<core>>
  component [VKB Server] as VKB <<api>>

  Dashboard -> Coordinator : managed by
  TranscriptMon -> Coordinator : managed by
  VKB --> StartScript : started by
}

note right of PSM_Registry
  **Single Source of Truth**
  - Tracks all processes
  - Session-aware
  - Auto-cleanup
  - File-locked
end note

note right of Coordinator
  **Service Lifecycle Manager**
  - Start/Stop/Restart
  - Health monitoring
  - Auto-recovery
  - Registers with PSM
end note

note right of Watchdog
  **Failsafe Monitor**
  - Runs every 60s (launchd)
  - Monitors coordinator
  - Auto-restart if dead
  - Uses PSM as truth
end note

@enduml
