@startuml enhanced-logging-flow

!include _standard-style.puml
skinparam activityStyle rounded
skinparam direction top to bottom layout

title Enhanced Live Logging Information Flow

start

:Tool Interaction Occurs;
note right: User calls any Claude Code tool

:StatusLine Hook Triggered;
note right: Constraint monitor captures\nstructured JSON data

partition "Real-Time Processing" {
    :Extract Tool Metadata;
    note right
        • Tool name and parameters
        • Result data
        • Execution context
        • Timestamp
    end note
    
    :Semantic Interpretation;
    note right
        Transform generic tool call into
        meaningful, human-readable summary
    end note
    
    if (Tool type?) then (File Operation)
        :Generate file summary;
        note right: Shows filenames, line counts, changes
    elseif (Command)
        :Generate command summary;  
        note right: Shows success/failure, output preview
    elseif (MCP Tool)
        :Generate MCP summary;
        note right: Server-specific formatting with results
    else (Other)
        :Generate generic summary;
    endif
    
    :Real-Time Classification;
    note right
        Score exchange against indicators:
        • Tools: MCP, knowledge management (30%)
        • Files: coding patterns (25%)  
        • Commands: system operations (20%)
        • Concepts: knowledge terms (15%)
        • Context: working directory (10%)
    end note
    
    if (Classification Score?) then (>70% Coding)
        :Route to coding/.specstory/;
        note right: System/knowledge work
    elseif (40-70% Hybrid)
        fork
            :Route to coding/.specstory/;
            note right: Cross-project impact context
        fork again
            :Route to .specstory/;  
            note right: Local project context
        end fork
    else (<40% Project)
        :Route to .specstory/;
        note right: Project-specific work
    endif
}

partition "Intelligent Documentation" {
    :Create Exchange Entry;
    note right
        ## Exchange N: [Context-Aware Title]
        **Time:** [Timestamp]
        **Classification:** [target] ([confidence]%)
        
        [Icon] **[Type]**: [Meaningful Summary]
        
        **Details:** [Tool parameters & results]
        **Classification Reasons:** [Why routed here]
        **Context:** [Workflow context]
    end note
    
    :Write to Log File(s);
    note right: Atomic write operations\nwith proper formatting
}

partition "Session Management" {
    :Update Session Metadata;
    note right
        • Exchange count
        • Classification breakdown  
        • Tools used
        • Session duration
    end note
    
    if (Session Active?) then (yes)
        :Continue Processing;
    else (no)
        :Finalize Session;
        :Generate Session Summary;
        stop
    endif
}

:Buffer Next Interaction;
note right: Ready for next tool call

stop

@enduml