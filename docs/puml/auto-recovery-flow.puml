@startuml
!include _standard-style.puml

title Auto-Recovery Flow & Plug'n'Play Behavior

participant "User Session" as User
participant "Global Watchdog" as GW
participant "Global LSL Coordinator" as GLC
participant "StatusLine Monitor" as SLM
participant "Enhanced Transcript Monitor" as ETM
participant "Health Files" as HF

== Normal Operation ==
User -> User : Start Claude session via `coding/bin/coding`
activate GLC
GLC -> ETM : Ensure transcript monitor for project
activate ETM
ETM -> HF : Write health data every 5 seconds
GLC -> GLC : Perform health check every 30 seconds
SLM -> HF : Read health data for statusLine
SLM -> User : Display 九C:游릭 CA:游릭 ND:游릭

== Auto-Recovery Scenario 1: Dead Monitor Detection ==
GLC -> ETM : Health check (kill -0 PID)
ETM --> GLC : Process not found
GLC -> GLC : Mark monitor as unhealthy
GLC -> ETM : Start new monitor process  
activate ETM
ETM -> HF : Resume health file updates
GLC -> GLC : Update registry with new PID
note right : **Plug'n'Play:** User continues working\nwithout interruption

== Auto-Recovery Scenario 2: Stale Health File ==
GLC -> HF : Read health file timestamp
HF --> GLC : File age > 60 seconds
GLC -> ETM : Kill stale monitor
deactivate ETM
GLC -> ETM : Start fresh monitor
activate ETM
ETM -> HF : Write current health data
note right : **Self-Healing:** System detects\nand fixes stale monitoring

== Auto-Recovery Scenario 3: Coordinator Failure ==
GW -> GLC : Health check (kill -0 PID)
GLC --> GW : Process not found
GW -> GW : Start new LSL Coordinator
activate GLC
GLC -> GLC : Update coordinator PID in registry
GLC -> ETM : Verify all project monitors
GLC -> GLC : Perform immediate health check
note right : **Layer 4 Protection:** Watchdog\nensures coordinator availability

== Dynamic Session Discovery ==
User -> User : Start new project session
SLM -> SLM : Scan ~/.claude/projects/ directory
SLM -> SLM : Discover new session pattern
SLM -> GLC : Request monitor for new project  
GLC -> ETM : Start monitor for new project
activate ETM
SLM -> User : Display updated status with new session
note right : **Zero-Config Discovery:** New sessions\nautomatically appear in statusLine

== StatusLine Update Flow ==
loop Every statusLine request
    SLM -> HF : Read health from all projects
    SLM -> SLM : Generate smart abbreviations
    SLM -> SLM : Aggregate individual statuses
    SLM -> User : Display C:游릭 CA:游릭 ND:游릭
end

note over User, HF
  **Key Recovery Features:**
  
  **1. Process Health Monitoring**
  - 30-second health checks on all monitors
  - kill -0 PID validation
  - Automatic process restart on failure
  
  **2. Health File Validation**  
  - 60-second staleness detection
  - Timestamp verification
  - Activity monitoring (exchange counts)
  
  **3. Dynamic Session Discovery**
  - Claude transcript directory scanning
  - Pattern-based project detection
  - Automatic monitor provisioning
  
  **4. Coordinator Self-Recovery**
  - PID registration on startup
  - Registry consistency checks
  - Watchdog process monitoring
end note

@enduml